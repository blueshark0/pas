<font style="color:rgb(59, 59, 59);background-color:rgb(248, 248, 248);">本系统采用前后端分离的架构，使用Vue作为前端框架，ThinkPHP作为后端框架。</font>

### 1.1 技术栈
**前端：**

+ Vue 3：前端框架
+ TypeScript：类型系统
+ Vite：构建工具
+ Pinia：状态管理
+ Vue Router：路由管理
+ Axios：HTTP客户端
+ Element Plus：UI组件库

**后端：**

+ ThinkPHP 8：后端PHP框架
+ MySQL：关系型数据库
+ RESTful API：前后端交互接口

### 1.2 系统架构图
```plain
+------------------+         +------------------+         +------------------+
|    客户端层      |         |     服务层       |         |     数据层       |
|   (Vue.js)       |<------->|   (ThinkPHP)     |<------->|    (MySQL)       |
+------------------+         +------------------+         +------------------+
| - 用户界面       |         | - 业务逻辑       |         | - 数据存储       |
| - 表单验证       |         | - API接口        |         | - 数据持久化     |
| - 路由管理       |         | - 数据处理       |         |                  |
| - 状态管理       |         | - 事务处理       |         |                  |
+------------------+         +------------------+         +------------------+
```

## 2. 数据库设计
### 2.1 表结构设计
#### 账户表（account）
| 字段名 | 类型 | 说明 | 备注 |
| --- | --- | --- | --- |
| id | int | 主键 | 自增 |
| current_balance | decimal(12,2) | 当前余额 | 精确到小数点后两位 |
| created_at | datetime | 创建时间 |  |
| updated_at | datetime | 更新时间 |  |


#### 预设交易表（preset_transaction）
| 字段名 | 类型 | 说明 | 备注 |
| --- | --- | --- | --- |
| id | int | 主键 | 自增 |
| type | tinyint | 交易类型 | 1-收入，2-支出 |
| amount | decimal(12,2) | 金额 | 精确到小数点后两位，正数 |
| execution_date | date | 执行日期 | 格式：YYYY-MM-DD |
| description | varchar(255) | 描述 | 可选 |
| status | tinyint | 状态 | 1-待执行，2-执行中（周期性的，才有执行中），3-已执行 4-终止 |
| is_recurring | tinyint | 是否周期性 | 0-否, 1-是 (默认为0) |
| recurrence_type | tinyint | 周期类型 | NULL/0-无, 1-每日, 2-每周, 3-每月, 4-每年 |
| recurrence_interval | int | 周期频率 | e.g., 1 (每类型单位), 2 (每2个类型单位) |
| recurrence_end_date | date | 周期结束日期 | 可为NULL, 表示无限期 |
| created_at | datetime | 创建时间 |  |
| updated_at | datetime | 更新时间 |  |


#### 余额变更历史表（balance_history）
| 字段名 | 类型 | 说明 | 备注 |
| --- | --- | --- | --- |
| id | int | 主键 | 自增 |
| timestamp | datetime | 变更时间 |  |
| change_type | tinyint | 变更类型 | 1-初始设置，2-收入执行，3-支出执行，4-手动编辑 |
| related_transaction_id | int | 关联交易ID | 可为NULL |
| amount_change | decimal(12,2) | 变更金额 | 可正可负 |
| balance_after | decimal(12,2) | 变更后余额 |  |
| created_at | datetime | 创建时间 |  |


### 2.2 索引设计
+ preset_transaction表：
    - execution_date + status 组合索引 (用于快速查找待执行的交易)
    - status 索引 (用于过滤不同状态的交易)
+ balance_history表：
    - timestamp 索引 (用于按时间查询)
    - related_transaction_id 索引 (用于关联查询)

## 3. 模块设计
### 3.1 前端模块设计
#### 页面组件结构
```plain
src/
├── views/
│   ├── HomeView.vue          // 主页视图，显示当前余额和即将执行的交易
│   ├── TransactionListView.vue // 预设交易列表视图
│   ├── TransactionEditView.vue // 添加/编辑预设交易视图
│   └── HistoryView.vue       // 余额历史记录视图
├── components/
│   ├── BalanceDisplay.vue    // 余额显示组件
│   ├── TransactionItem.vue   // 单条交易项组件
│   ├── TransactionForm.vue   // 交易表单组件
│   └── HistoryItem.vue       // 历史记录项组件
├── stores/
│   ├── account.ts            // 账户状态管理
│   ├── transaction.ts        // 交易状态管理
│   └── history.ts            // 历史记录状态管理
├── services/
│   ├── api.ts                // API请求封装
│   └── dateUtils.ts          // 日期处理工具
└── router/
    └── index.ts              // 路由配置
```

#### 状态管理设计
使用Pinia进行状态管理，主要包含三个store：

1. **账户Store (account.ts)**
    - 维护当前余额状态
    - 提供余额初始化和更新方法
2. **交易Store (transaction.ts)**
    - 维护预设交易列表
    - 提供添加、修改、删除、查询交易方法
    - 负责交易状态的改变
3. **历史记录Store (history.ts)**
    - 维护余额变更历史记录
    - 提供查询历史记录的方法

### 3.2 后端模块设计
#### 控制器设计
```plain
app/controller/
├── Account.php      // 账户控制器，处理余额相关请求
├── Transaction.php  // 交易控制器，处理预设交易相关请求
└── History.php      // 历史记录控制器，处理历史记录相关请求
```

#### 模型设计
```plain
app/model/
├── Account.php             // 账户模型
├── PresetTransaction.php   // 预设交易模型
└── BalanceHistory.php      // 余额历史模型
```

#### 服务层设计
```plain
app/service/
├── AccountService.php      // 账户服务，处理复杂业务逻辑
├── TransactionService.php  // 交易服务，处理交易执行逻辑
└── HistoryService.php      // 历史记录服务，处理历史记录生成逻辑
```

## 4. API接口设计
### 4.1 账户相关接口
#### 获取当前余额
+ 请求方式：GET
+ 路径：/api/account/balance
+ 响应：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "current_balance": 10000.00
  }
}
```

#### 设置初始余额
+ 请求方式：POST
+ 路径：/api/account/init
+ 请求体：

```json
{
  "initial_balance": 5000.00
}
```

+ 响应：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "current_balance": 5000.00
  }
}
```

### 4.2 预设交易相关接口
#### 获取交易列表
+ 请求方式：GET
+ 路径：/api/transaction/list
+ 参数：status (可选，1-待执行，2-已执行)
+ 响应：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "type": 1,
        "amount": 3000.00,
        "execution_date": "2025-04-20",
        "description": "工资收入",
        "status": 1,
        "created_at": "2025-04-16 10:00:00"
      },
      // ...
    ],
    "total": 10
  }
}
```

#### 添加预设交易
+ 请求方式：POST
+ 路径：/api/transaction/add
+ 请求体：

```json
{
  "type": 1,
  "amount": 3000.00,
  "execution_date": "2025-04-20",
  "description": "工资收入"
}
```

+ 响应：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": 1
  }
}
```

#### 修改预设交易
+ 请求方式：PUT
+ 路径：/api/transaction/{id}
+ 请求体：

```json
{
  "amount": 3500.00,
  "execution_date": "2025-04-21",
  "description": "修改后的工资收入"
}
```

+ 响应：

```json
{
  "code": 0,
  "msg": "success",
  "data": null
}
```

#### 删除预设交易
+ 请求方式：DELETE
+ 路径：/api/transaction/{id}
+ 响应：

```json
{
  "code": 0,
  "msg": "success",
  "data": null
}
```

### 4.3 历史记录相关接口
#### 获取历史记录列表
+ 请求方式：GET
+ 路径：/api/history/list
+ 参数：
    - page_size (可选，默认20)
    - page (可选，默认1)
+ 响应：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "timestamp": "2025-04-16 08:00:00",
        "change_type": 1,
        "related_transaction_id": null,
        "amount_change": 5000.00,
        "balance_after": 5000.00
      },
      // ...
    ],
    "total": 5
  }
}
```

## 5. 核心业务流程
### 5.1 自动余额更新流程
1. 用户打开应用
2. 前端在应用初始化时，发送请求检查是否有待执行的交易
3. 后端查询执行日期为当天或早于当天但尚未执行的预设交易
4. 对每一笔待执行的交易：
    - 更新账户余额（收入加、支出减）
    - 将交易状态改为"已执行"
    - 生成对应的余额变更历史记录
5. 返回更新后的余额和已执行的交易列表给前端
6. 前端更新本地状态，并通知用户交易执行情况

```plain
+------------+                +------------+                +------------+
|   前端     |                |   后端     |                |   数据库   |
+------------+                +------------+                +------------+
      |                             |                             |
      | 1. 应用启动                 |                             |
      |--------------------------->|                             |
      |                             |                             |
      |                             | 2. 查询待执行交易           |
      |                             |--------------------------->|
      |                             |                             |
      |                             | 3. 返回待执行交易列表       |
      |                             |<---------------------------|
      |                             |                             |
      |                             | 4. 处理每笔交易             |
      |                             |--------------------------->|
      |                             |                             |
      |                             | 5. 更新余额和交易状态       |
      |                             |--------------------------->|
      |                             |                             |
      |                             | 6. 生成历史记录             |
      |                             |--------------------------->|
      |                             |                             |
      | 7. 返回处理结果             |                             |
      |<---------------------------|                             |
      |                             |                             |
      | 8. 更新UI和状态             |                             |
      |                             |                             |
```

### 5.2 添加预设交易流程
1. 用户在交易列表界面点击"添加"按钮
2. 跳转到添加交易界面
3. 用户填写交易信息（类型、金额、日期、描述）
4. 用户点击"保存"按钮
5. 前端验证输入数据
6. 发送API请求到后端
7. 后端验证数据，创建交易记录
8. 返回结果给前端
9. 前端显示成功提示，更新交易列表

## 6. 前端界面设计概要
### 6.1 主界面
+ 顶部：显示当前余额（大字体、醒目）
+ 中部：展示即将执行的交易（最近3-5条）
+ 底部：导航栏，可快速跳转到交易列表、添加交易、历史记录等页面

### 6.2 交易列表界面
+ 顶部：筛选条件（全部/待执行/已执行）
+ 中部：交易列表，每项显示：
    - 类型图标（收入/支出）
    - 金额（收入绿色、支出红色）
    - 执行日期
    - 描述
    - 状态标签
+ 底部：添加按钮（浮动按钮）

### 6.3 添加/编辑交易界面
+ 表单内容：
    - 类型选择（收入/支出，可使用开关按钮）
    - 金额输入框（带数字键盘）
    - 日期选择器
    - 描述输入框
+ 操作按钮：
    - 保存按钮
    - 取消按钮

### 6.4 历史记录界面
+ 时间线形式展示每条余额变更记录
+ 每条记录显示：
    - 变更时间
    - 变更类型
    - 变更金额（增加/减少）
    - 变更后余额

## 7. 实现重点与注意事项
### 7.1 技术实现重点
1. **数据精确性**
    - 采用decimal类型存储金额，避免浮点数精度问题
    - 余额计算逻辑需确保准确无误
2. **事务处理**
    - 使用数据库事务确保余额更新与交易状态变更的原子性
    - 防止因网络问题或系统异常导致数据不一致
3. **日期处理**
    - 前后端统一日期格式和时区处理
    - 准确判断交易执行状态
4. **自动更新机制**
    - 应用启动时检查并处理待执行交易
    - 防止重复执行或漏执行交易

### 7.2 性能优化考虑
1. 针对大量交易数据的分页查询优化
2. 为常用查询添加适当的索引
3. 前端列表的虚拟滚动或分页加载

### 7.3 安全考虑
1. 输入验证和防XSS处理
2. 敏感操作的日志记录
3. 数据备份策略

## 8. 开发计划与里程碑
### 8.1 阶段一：基础框架搭建（5个工作日）
+ 前端项目初始化与基础组件开发
+ 后端项目初始化与数据库设计实现
+ API接口定义与基础通信测试

### 8.2 阶段二：核心功能实现（10个工作日）
+ 账户余额管理功能实现
+ 预设交易CRUD功能实现
+ 自动余额更新核心逻辑实现
+ 历史记录功能实现

### 8.3 阶段三：UI完善与测试（5个工作日）
+ 界面美化与交互优化
+ 功能集成测试
+ 性能优化
+ 问题修复

### 8.4 阶段四：部署与上线准备（3个工作日）
+ 生产环境配置
+ 部署脚本准备
+ 上线检查清单
+ 文档完善

## 9. 扩展性设计
为满足未来可能的需求，系统设计考虑了以下扩展点：

1. **多账户支持**
    - 数据库设计预留用户ID字段
    - 接口设计支持多账户标识
2. **周期性交易**
    - 交易表结构预留周期类型字段
    - 服务层考虑周期执行逻辑
3. **分类与标签**
    - 可增加分类表和标签关联表
    - UI预留分类展示位置
4. **数据分析**
    - 历史数据结构支持统计分析
    - 接口设计预留统计查询入口

